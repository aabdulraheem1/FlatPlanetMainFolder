<!-- Enhanced Inventory Analysis Section -->
<div class="container mt-5">
    {% csrf_token %}
    <h2>Enhanced Inventory Analysis</h2>
    
    <!-- Filter and Control Row -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="form-group">
                <label for="productGroupFilter" class="font-weight-bold">Filter by Parent Product Group:</label>
                <select id="productGroupFilter" class="form-control">
                    <option value="All Product Groups">All Product Groups</option>
                    {% for group in available_parent_groups %}
                        {% if group != "All Product Groups" %}
                            <option value="{{ group }}">{{ group }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label class="font-weight-bold">Export Options:</label>
                <div class="btn-group d-block">
                    <button type="button" class="btn btn-success btn-sm" onclick="exportInventoryData('excel')">
                        <i class="fas fa-file-excel"></i> Export to Excel
                    </button>
                    <button type="button" class="btn btn-info btn-sm" onclick="exportInventoryData('csv')">
                        <i class="fas fa-file-csv"></i> Export to CSV
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Summary Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h4 id="totalInventoryValue">Loading...</h4>
                    <p class="mb-0">
                        <span id="inventoryDate">{% if snapshot_date %}As of: {{ snapshot_date }}{% else %}Date not available{% endif %}</span><br>
                        <span id="selectedGroupName">Product Groups</span>
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabs for Chart and Table Views -->
    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="inventoryTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="chart-tab" data-toggle="tab" href="#chartView" role="tab" aria-controls="chartView" aria-selected="true">
                        <i class="fas fa-chart-line"></i> Chart View
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="table-tab" data-toggle="tab" href="#tableView" role="tab" aria-controls="tableView" aria-selected="false">
                        <i class="fas fa-table"></i> Table View
                    </a>
                </li>
            </ul>
        </div>
        
        <div class="card-body">
            <div class="tab-content" id="inventoryTabsContent">
                <!-- Chart View Tab -->
                <div class="tab-pane fade show active" id="chartView" role="tabpanel" aria-labelledby="chart-tab">
                    <h5>Enhanced Inventory Projection - 4-Line Financial View (Next 24 Months)</h5>
                    <div style="height: 500px;">
                        <canvas id="enhancedInventoryChart"></canvas>
                    </div>
                    
                    <!-- Chart Legend -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="d-flex justify-content-center flex-wrap">
                                <span class="badge badge-success mr-2 mb-1">
                                    <i class="fas fa-square"></i> Revenue (AUD)
                                </span>
                                <span class="badge badge-danger mr-2 mb-1">
                                    <i class="fas fa-square"></i> COGS (AUD)
                                </span>
                                <span class="badge badge-primary mr-2 mb-1">
                                    <i class="fas fa-square"></i> Production Value (AUD)
                                </span>
                                <span class="badge badge-warning mr-2 mb-1">
                                    <i class="fas fa-square"></i> Inventory Projection (AUD)
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Table View Tab -->
                <div class="tab-pane fade" id="tableView" role="tabpanel" aria-labelledby="table-tab">
                    <h5>Detailed Inventory Projection Data</h5>
                    
                    <!-- Table Controls -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="tableSearch">Search:</label>
                                <input type="text" id="tableSearch" class="form-control form-control-sm" placeholder="Search month, product group...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="tablePageSize">Rows per page:</label>
                                <select id="tablePageSize" class="form-control form-control-sm">
                                    <option value="10">10</option>
                                    <option value="25" selected>25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Table -->
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table id="inventoryTable" class="table table-striped table-bordered table-sm">
                            <thead class="thead-dark sticky-top">
                                <tr>
                                    <th>Month</th>
                                    <th>Parent Product Group</th>
                                    <th>Production AUD</th>
                                    <th>COGS AUD</th>
                                    <th>Revenue AUD</th>
                                    <th>Opening Inventory AUD</th>
                                    <th>Closing Inventory AUD</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div id="tableInfo" class="text-muted small"></div>
                        </div>
                        <div class="col-md-6">
                            <nav aria-label="Table pagination">
                                <ul class="pagination pagination-sm justify-content-end" id="tablePagination">
                                    <!-- Pagination will be generated by JavaScript -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get data from Django context
    let inventoryProjectionData = {};
    let inventoryTableData = [];
    let filteredTableData = [];
    let currentTablePage = 1;
    let tablePageSize = 25;
    let inventoryChart;
    
    // Get snapshot date from Django context
    let inventorySnapshotDate = null;
    
    try {
        // Get snapshot date from Django context
        {% if inventory_snapshot_date %}
            inventorySnapshotDate = '{{ inventory_snapshot_date|date:"Y-m-d" }}';
        {% endif %}
        
        console.log('DEBUG: Inventory snapshot date:', inventorySnapshotDate);
        
    } catch (error) {
        console.error('Error loading Django context data:', error);
    }

    // Load data from Django context
    try {
        {% comment %} Get Django data safely {% endcomment %}
        {% if inventory_projection_chart_data %}
            inventoryProjectionData = JSON.parse('{{ inventory_projection_chart_data|escapejs }}');
        {% endif %}
        {% if inventory_projection_table_data %}
            inventoryTableData = JSON.parse('{{ inventory_projection_table_data|escapejs }}');
        {% endif %}
        
        console.log('DEBUG: Loaded projection data:', inventoryProjectionData);
        console.log('DEBUG: Loaded table data length:', inventoryTableData.length);
        
    } catch (error) {
        console.error('❌ Error loading inventory projection data:', error);
        inventoryProjectionData = {};
        inventoryTableData = [];
    }

    // Initialize chart
    function initializeChart() {
        const ctx = document.getElementById('enhancedInventoryChart');
        if (!ctx) {
            console.error('❌ Chart canvas not found');
            return;
        }
        
        const selectedGroup = document.getElementById('productGroupFilter').value || 'All Product Groups';
        const currentData = inventoryProjectionData[selectedGroup];
        
        if (!currentData) {
            console.warn('⚠️ No data for selected group:', selectedGroup);
            return;
        }
        
        // Destroy existing chart if it exists
        if (inventoryChart) {
            inventoryChart.destroy();
        }
        
        inventoryChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: currentData.labels || [],
                datasets: [
                    {
                        label: 'Revenue (AUD)',
                        data: currentData.revenue || [],
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        yAxisID: 'y',
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'COGS (AUD)',
                        data: currentData.cogs || [],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        yAxisID: 'y',
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Production Value (AUD)',
                        data: currentData.production || [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        yAxisID: 'y',
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Inventory Projection (AUD)',
                        data: currentData.inventoryProjection || [],
                        borderColor: 'rgb(251, 191, 36)',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        yAxisID: 'y2',
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        borderWidth: 3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Enhanced Inventory Analysis - ' + selectedGroup,
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    },
                    legend: {
                        display: true,
                        position: 'bottom'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y;
                                return context.dataset.label + ': $' + value.toLocaleString('en-AU', {
                                    minimumFractionDigits: 0,
                                    maximumFractionDigits: 0
                                });
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Month'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Financial Values (AUD)'
                        },
                        ticks: {
                            callback: function(value) {
                                return '$' + (value / 1000000).toFixed(1) + 'M';
                            }
                        }
                    },
                    y2: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Inventory Value (AUD)'
                        },
                        ticks: {
                            callback: function(value) {
                                return '$' + (value / 1000000).toFixed(1) + 'M';
                            }
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
        
        // Update summary card
        updateSummaryCard(selectedGroup, currentData);
    }
    
    // Update summary card with current data
    function updateSummaryCard(groupName, data) {
        let totalInventoryValue = 0;
        
        // Date is now handled directly in the HTML template - no JavaScript needed
        
        // Calculate opening inventory value from the existing table data (much faster!)
        if (inventoryTableData && inventoryTableData.length > 0) {
            // Filter table data for the selected group
            const relevantData = inventoryTableData.filter(row => 
                groupName === 'All Product Groups' || row.parent_product_group === groupName
            );
            
            if (relevantData.length > 0) {
                // Get the first month's opening inventory for each group (this represents the snapshot opening inventory)
                const groupInventory = {};
                relevantData.forEach(row => {
                    const group = row.parent_product_group;
                    if (!groupInventory[group]) {
                        // Use the first occurrence (earliest month) opening inventory for each group
                        groupInventory[group] = parseFloat(row.opening_inventory_aud || 0);
                    }
                });
                
                // Sum all groups if "All Product Groups", otherwise get specific group
                if (groupName === 'All Product Groups') {
                    totalInventoryValue = Object.values(groupInventory).reduce((sum, value) => sum + value, 0);
                } else {
                    totalInventoryValue = groupInventory[groupName] || 0;
                }
            }
        } else {
            console.warn('No inventory table data available');
            totalInventoryValue = 0;
        }
        
        // Update the UI elements
        const totalValueElement = document.getElementById('totalInventoryValue');
        const groupNameElement = document.getElementById('selectedGroupName');
        
        if (totalValueElement) {
            if (totalInventoryValue > 0) {
                totalValueElement.textContent = '$' + (totalInventoryValue / 1000000).toFixed(1) + 'M AUD';
            } else {
                totalValueElement.textContent = '$0.0M AUD';
            }
        }
        
        if (groupNameElement) {
            groupNameElement.textContent = groupName;
        }
        
        console.log('DEBUG: Updated summary card:', {
            group: groupName,
            value: totalInventoryValue,
            valueFormatted: '$' + (totalInventoryValue / 1000000).toFixed(1) + 'M AUD'
        });
    }
    
    // Filter functionality
    document.getElementById('productGroupFilter').addEventListener('change', function(e) {
        console.log('🔄 Filter changed to:', e.target.value);
        initializeChart();
        filterTableData();
    });
    
    // Table functionality
    function filterTableData() {
        const selectedGroup = document.getElementById('productGroupFilter').value;
        const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
        
        filteredTableData = inventoryTableData.filter(row => {
            const matchesGroup = selectedGroup === 'All Product Groups' || 
                                row.parent_product_group === selectedGroup;
            const matchesSearch = !searchTerm || 
                                Object.values(row).some(val => 
                                    String(val).toLowerCase().includes(searchTerm));
            return matchesGroup && matchesSearch;
        });
        
        currentTablePage = 1;
        renderTable();
        
        // Update summary card with filtered data
        const currentData = inventoryProjectionData[selectedGroup];
        updateSummaryCard(selectedGroup, currentData);
    }
    
    function renderTable() {
        const startIndex = (currentTablePage - 1) * tablePageSize;
        const endIndex = startIndex + tablePageSize;
        const pageData = filteredTableData.slice(startIndex, endIndex);
        
        const tbody = document.getElementById('inventoryTableBody');
        tbody.innerHTML = '';
        
        pageData.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = 
                '<td>' + row.month + '</td>' +
                '<td>' + row.parent_product_group + '</td>' +
                '<td>$' + parseFloat(row.production_aud).toLocaleString('en-AU', {minimumFractionDigits: 2}) + '</td>' +
                '<td>$' + parseFloat(row.cogs_aud).toLocaleString('en-AU', {minimumFractionDigits: 2}) + '</td>' +
                '<td>$' + parseFloat(row.revenue_aud).toLocaleString('en-AU', {minimumFractionDigits: 2}) + '</td>' +
                '<td>$' + parseFloat(row.opening_inventory_aud).toLocaleString('en-AU', {minimumFractionDigits: 2}) + '</td>' +
                '<td>$' + parseFloat(row.closing_inventory_aud).toLocaleString('en-AU', {minimumFractionDigits: 2}) + '</td>';
            tbody.appendChild(tr);
        });
        
        updateTablePagination();
        updateTableInfo();
    }
    
    function updateTablePagination() {
        const totalPages = Math.ceil(filteredTableData.length / tablePageSize);
        const pagination = document.getElementById('tablePagination');
        pagination.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = 'page-item ' + (currentTablePage === 1 ? 'disabled' : '');
        prevLi.innerHTML = '<a class="page-link" href="#" data-page="' + (currentTablePage - 1) + '">Previous</a>';
        pagination.appendChild(prevLi);
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentTablePage - 2 && i <= currentTablePage + 2)) {
                const li = document.createElement('li');
                li.className = 'page-item ' + (i === currentTablePage ? 'active' : '');
                li.innerHTML = '<a class="page-link" href="#" data-page="' + i + '">' + i + '</a>';
                pagination.appendChild(li);
            } else if (i === currentTablePage - 3 || i === currentTablePage + 3) {
                const li = document.createElement('li');
                li.className = 'page-item disabled';
                li.innerHTML = '<span class="page-link">...</span>';
                pagination.appendChild(li);
            }
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = 'page-item ' + (currentTablePage === totalPages ? 'disabled' : '');
        nextLi.innerHTML = '<a class="page-link" href="#" data-page="' + (currentTablePage + 1) + '">Next</a>';
        pagination.appendChild(nextLi);
    }
    
    function updateTableInfo() {
        const startIndex = (currentTablePage - 1) * tablePageSize + 1;
        const endIndex = Math.min(currentTablePage * tablePageSize, filteredTableData.length);
        const total = filteredTableData.length;
        
        document.getElementById('tableInfo').textContent = 
            'Showing ' + startIndex + ' to ' + endIndex + ' of ' + total + ' entries';
    }
    
    // Event listeners
    document.getElementById('tableSearch').addEventListener('input', filterTableData);
    document.getElementById('tablePageSize').addEventListener('change', function(e) {
        tablePageSize = parseInt(e.target.value);
        currentTablePage = 1;
        renderTable();
    });
    
    // Pagination click handler
    document.getElementById('tablePagination').addEventListener('click', function(e) {
        e.preventDefault();
        if (e.target.tagName === 'A' && !e.target.parentElement.classList.contains('disabled')) {
            const page = parseInt(e.target.dataset.page);
            if (page && page !== currentTablePage) {
                currentTablePage = page;
                renderTable();
            }
        }
    });
    
    // Export functionality
    window.exportInventoryData = function(format) {
        const selectedGroup = document.getElementById('productGroupFilter').value;
        console.log('Exporting ' + selectedGroup + ' inventory data to ' + format.toUpperCase() + '...');
        
        try {
            const exportData = prepareExportData();
            const filename = 'inventory_analysis_' + selectedGroup.replace(/\s+/g, '_') + '_' + getCurrentDateString();
            
            if (format === 'csv') {
                downloadCSV(exportData, filename + '.csv');
            } else if (format === 'excel') {
                // For Excel export, convert to CSV for simplicity
                // In a real implementation, you'd use a library like SheetJS
                downloadCSV(exportData, filename + '.csv');
            }
        } catch (error) {
            console.error('❌ Export failed:', error);
            alert('Export failed. Please try again.');
        }
    };
    
    function prepareExportData() {
        const selectedGroup = document.getElementById('productGroupFilter').value;
        const dataToExport = selectedGroup === 'All Product Groups' ? 
                           inventoryTableData : 
                           inventoryTableData.filter(row => row.parent_product_group === selectedGroup);
        
        const exportRows = [];
        exportRows.push([
            'Month', 'Parent Product Group', 
            'Production AUD', 'COGS AUD', 'Revenue AUD', 
            'Opening Inventory AUD', 'Closing Inventory AUD'
        ]);
        
        dataToExport.forEach(row => {
            exportRows.push([
                row.month,
                row.parent_product_group,
                parseFloat(row.production_aud).toFixed(2),
                parseFloat(row.cogs_aud).toFixed(2),
                parseFloat(row.revenue_aud).toFixed(2),
                parseFloat(row.opening_inventory_aud).toFixed(2),
                parseFloat(row.closing_inventory_aud).toFixed(2)
            ]);
        });
        
        return exportRows;
    }
    
    function downloadCSV(data, filename) {
        const csvContent = data.map(row => 
            row.map(cell => 
                typeof cell === 'string' && cell.includes(',') ? '"' + cell + '"' : cell
            ).join(',')
        ).join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
    
    function getCurrentDateString() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');
        return year + month + day + '_' + hour + minute;
    }

    // Initialize everything
    if (Object.keys(inventoryProjectionData).length > 0) {
        console.log('✅ Initializing enhanced inventory analysis...');
        initializeChart();
        filterTableData();
    } else {
        console.warn('⚠️ No inventory projection data available. The model may need to be calculated first.');
        document.getElementById('enhancedInventoryChart').style.display = 'none';
        const tableBody = document.getElementById('inventoryTableBody');
        if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No data available. Please run the model calculation first.</td></tr>';
        }
    }
});
</script>
