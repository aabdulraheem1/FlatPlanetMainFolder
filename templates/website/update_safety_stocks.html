{% extends 'website/base.html' %}

{% block title %}Update Safety Stocks - {{ scenario.version }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center mb-4">Update Safety Stocks - Scenario: {{ scenario.version }}</h1>
            
            <!-- Filter Form -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Filter Records</h5>
                </div>
                <div class="card-body">
                    <form method="get" class="row">
                        <div class="col-md-4">
                            <label for="plant" class="form-label">Plant:</label>
                            <input type="text" class="form-control form-control-lg filter-input" id="plant" name="plant" value="{{ plant_filter }}" placeholder="Enter plant name">
                        </div>
                        <div class="col-md-4">
                            <label for="part" class="form-label">Part Number:</label>
                            <input type="text" class="form-control form-control-lg filter-input" id="part" name="part" value="{{ part_filter }}" placeholder="Enter part number">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="w-100">
                                <button type="submit" class="btn btn-primary btn-lg w-100 mb-2">Filter</button>
                                <a href="{% url 'update_safety_stocks' scenario.version %}" class="btn btn-secondary btn-lg w-100">Clear</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Records Count -->
            <div class="alert alert-info">
                Total Records: {{ page_obj.paginator.count }} | Showing {{ page_obj.start_index }}-{{ page_obj.end_index }}
            </div>

            <!-- Update Form -->
            <form method="post" id="updateForm">
                {% csrf_token %}
                {{ formset.management_form }}
                
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th class="col-plant">Plant</th>
                                <th class="col-part">Part Number</th>
                                <th class="col-min">Minimum Qty</th>
                                <th class="col-safety">Safety Qty</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for form in formset %}
                                <tr>
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                    
                                    <td class="col-plant">
                                        {{ form.Plant }}
                                        {% if form.Plant.errors %}
                                            <div class="text-danger small">{{ form.Plant.errors }}</div>
                                        {% endif %}
                                    </td>
                                    
                                    <td class="col-part">
                                        {{ form.PartNum }}
                                        {% if form.PartNum.errors %}
                                            <div class="text-danger small">{{ form.PartNum.errors }}</div>
                                        {% endif %}
                                    </td>
                                    
                                    <td class="col-min">
                                        {{ form.MinimumQty }}
                                        {% if form.MinimumQty.errors %}
                                            <div class="text-danger small">{{ form.MinimumQty.errors }}</div>
                                        {% endif %}
                                    </td>
                                    
                                    <td class="col-safety">
                                        {{ form.SafetyQty }}
                                        {% if form.SafetyQty.errors %}
                                            <div class="text-danger small">{{ form.SafetyQty.errors }}</div>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">No safety stocks records found.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if plant_filter %}&plant={{ plant_filter }}{% endif %}{% if part_filter %}&part={{ part_filter }}{% endif %}">&laquo; First</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if plant_filter %}&plant={{ plant_filter }}{% endif %}{% if part_filter %}&part={{ part_filter }}{% endif %}">Previous</a>
                                </li>
                            {% endif %}

                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}{% if plant_filter %}&plant={{ plant_filter }}{% endif %}{% if part_filter %}&part={{ part_filter }}{% endif %}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if plant_filter %}&plant={{ plant_filter }}{% endif %}{% if part_filter %}&part={{ part_filter }}{% endif %}">Next</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if plant_filter %}&plant={{ plant_filter }}{% endif %}{% if part_filter %}&part={{ part_filter }}{% endif %}">Last &raquo;</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}

                <!-- Action Buttons -->
                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'edit_scenario' scenario.version %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Scenario
                    </a>
                    
                    <div>
                        <button type="button" class="btn btn-warning" onclick="confirmUpdate()">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Updating safety stocks data...</p>
            </div>
        </div>
    </div>
</div>

<style>
/* Filter input styling - Make them bigger and prevent auto-resize */
.filter-input {
    min-width: 300px !important;
    width: 100% !important;
    height: calc(3.5rem + 2px) !important; /* Extra large height */
    padding: 1rem 1.25rem !important;
    font-size: 1.25rem !important;
}

/* Column width definitions */
.col-plant {
    width: 20%;
}

.col-part {
    width: 50%;
}

.col-min {
    width: 15%;
}

.col-safety {
    width: 15%;
}

/* Table styling */
.table {
    table-layout: fixed;
    width: 100%;
}

.table input {
    border: 1px solid #ddd;
    padding: 8px;
    border-radius: 3px;
    font-size: 14px;
    width: 100%;
    box-sizing: border-box;
    min-width: 120px;
}

.table input:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.table td {
    vertical-align: middle;
    padding: 12px;
    min-width: 120px;
}

.table th {
    background-color: #343a40;
    color: white;
    font-weight: bold;
    text-align: center;
    padding: 15px 12px;
    vertical-align: middle;
}

/* Specific styling for part number column */
.col-part input {
    min-width: 200px;
}

.col-plant input {
    min-width: 80px;
}

/* Filter form styling */
.form-control-lg {
    height: calc(3.5rem + 2px) !important;
    padding: 1rem 1.25rem !important;
    font-size: 1.25rem !important;
}

.btn-lg {
    padding: 1rem 1.25rem;
    font-size: 1.25rem;
}

/* Pagination styling */
.pagination .page-link {
    color: #007bff;
}

.pagination .page-item.active .page-link {
    background-color: #007bff;
    border-color: #007bff;
}

/* Card styling */
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.alert-info {
    background-color: #d1ecf1;
    border-color: #bee5eb;
    color: #0c5460;
}

.btn {
    margin: 2px;
}

.table-responsive {
    max-height: 600px;
    overflow-y: auto;
    overflow-x: auto;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .col-plant {
        width: 15%;
    }
    
    .col-part {
        width: 45%;
    }
    
    .col-min {
        width: 20%;
    }
    
    .col-safety {
        width: 20%;
    }
    
    .table input {
        font-size: 12px;
        padding: 6px;
    }
    
    .filter-input {
        min-width: 200px !important;
        font-size: 1rem !important;
    }
}
</style>

<script>
function confirmUpdate() {
    if (confirm('Are you sure you want to save these changes?')) {
        // Show loading modal
        var loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
        loadingModal.show();
        
        // Submit the form
        document.getElementById('updateForm').submit();
    }
}

// Only highlight changed fields - NO AUTO-RESIZE
document.addEventListener('DOMContentLoaded', function() {
    // Only apply to table inputs, not filter inputs
    const tableInputs = document.querySelectorAll('.table input');
    tableInputs.forEach(input => {
        const originalValue = input.value;
        
        input.addEventListener('change', function() {
            if (this.value !== originalValue) {
                this.classList.add('border-warning');
                this.style.backgroundColor = '#fff3cd';
            } else {
                this.classList.remove('border-warning');
                this.style.backgroundColor = '';
            }
        });
    });
});
</script>
{% endblock %}