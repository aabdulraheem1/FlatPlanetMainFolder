{% extends "website/base.html" %}
{% load humanize %}
{% load custom_filters %}
{% block content %}
<h3>Edit Product Costs for {{ scenario.version }}</h3>

<form method="get" class="form-inline mb-3">
    <div class="form-group">
        <label for="product" class="mr-2">Filter by Product:</label>
        <input type="text" id="product" name="product" value="{{ product_filter }}" class="form-control mr-2">
    </div>
    <div class="form-group">
        <label for="site" class="mr-2">Filter by Site:</label>
        <input type="text" id="site" name="site" value="{{ site_filter }}" class="form-control mr-2">
    </div>
    <button type="submit" class="btn btn-primary">Filter</button>
</form>

<form method="post">
    {% csrf_token %}
    <table class="table">
       <thead>
    <tr>
        <th>Product</th>
        <th>Site</th>
        <th colspan="2" style="border:2px solid #888; text-align:center; background:#f8f9fa;">
            Last Receipt
            <div style="font-weight:normal; font-size:small;">Cost AUD &amp; Date</div>
        </th>
        <th>Revenue Cost AUD</th>
        <th>Warehouse Cost</th> <!-- New column -->
    </tr>
    <tr>
        <th style="padding:4px;"></th>
        <th style="padding:4px;"></th>
        <th style="border-left:2px solid #888; border-top:2px solid #888; border-bottom:2px solid #888; padding:2px 6px; width:90px;">Cost AUD</th>
        <th style="border-right:2px solid #888; border-top:2px solid #888; border-bottom:2px solid #888; padding:2px 6px; width:110px;">Date</th>
        <th style="padding:4px;"></th>
        <th style="padding:4px;">Warehouse Cost</th> <!-- New column header -->
    </tr>
</thead>
<tbody>
    {% for cost in costs %}
    <tr>
        <td style="padding:4px 8px;">{{ cost.product.Product }}</td>
        <td style="padding:4px 8px;">{{ cost.site.SiteName }}</td>
        <!-- Show formatted value below the input for Cost AUD and Revenue Cost AUD -->
<td style="border-left:2px solid #888; border-top:2px solid #888; border-bottom:2px solid #888; padding:2px 6px;">
    <input type="number" step="0.1" name="cost_aud_{{ cost.id }}" value="{{ cost.cost_aud|floatformat:1|default_if_none:'' }}" style="width:80px;">
    <div style="font-size:smaller; color:#555;">
        {{ cost.cost_aud|floatformat:1|intcomma|default_if_none:"" }}
    </div>
</td>
<td style="border-right:2px solid #888; border-top:2px solid #888; border-bottom:2px solid #888; padding:2px 6px;">
    <input type="date" name="cost_date_{{ cost.id }}" value="{{ cost.cost_date|date:'Y-m-d' }}" style="width:110px;">
</td>
<td style="padding:2px 6px;">
    <input type="number" step="0.1" name="revenue_cost_aud_{{ cost.id }}" value="{{ cost.revenue_cost_aud|floatformat:1|default_if_none:'' }}" style="width:90px;">
    <div style="font-size:smaller; color:#555;">
        {{ cost.revenue_cost_aud|floatformat:1|intcomma|default_if_none:"" }}
    </div>
</td>
<td style="padding:2px 6px;">
    {% warehouse_cost warehouse_cost_lookup cost.product.pk cost.site.pk as warehouse_cost %}
    {% if warehouse_cost %}
        {{ warehouse_cost|floatformat:1|intcomma }}
    {% else %}
        <span style="color:#aaa;">â€”</span>
    {% endif %}
</td>
    </tr>
    {% endfor %}
</tbody>
    </table>
    <!-- Pagination controls -->
<nav aria-label="Page navigation">
  <ul class="pagination">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}&product={{ product_filter }}&site={{ site_filter }}" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
    {% endif %}

    {# Show up to 5 page numbers centered on the current page #}
    {% with total=page_obj.paginator.num_pages current=page_obj.number %}
      {% if total <= 5 %}
        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}&product={{ product_filter }}&site={{ site_filter }}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}
      {% else %}
        {% for num in page_obj.paginator.page_range %}
          {% if num >= current|add:'-2' and num <= current|add:'2' %}
            {% if page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% else %}
              <li class="page-item"><a class="page-link" href="?page={{ num }}&product={{ product_filter }}&site={{ site_filter }}">{{ num }}</a></li>
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}&product={{ product_filter }}&site={{ site_filter }}" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
    {% endif %}
  </ul>
</nav>
    <button type="submit" class="btn btn-success">Save Changes</button>
    <a href="{% url 'edit_scenario' scenario.version %}" class="btn btn-secondary">Back</a>
</form>
{% endblock %}