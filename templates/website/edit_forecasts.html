{% extends 'website/base.html' %}

{% block title %}Edit Forecasts{% endblock %}

{% block content %}
<style>
    #forecastTable input[type="text"], 
    #forecastTable input[type="number"], 
    #forecastTable input[type="date"] {
        width: 120px;
        min-width: 80px;
        max-width: 180px;
        padding: 2px 6px;
        font-size: 0.95rem;
    }
    #forecastTable td, #forecastTable th {
        vertical-align: middle;
        text-align: left;
    }
    #forecastTable td.price-aud-cell input {
        width: 80px;
        min-width: 60px;
        max-width: 100px;
        text-align: right;
        font-family: monospace;
        background: #f8f9fa;
    }
    #forecastTable th.price-aud-header {
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
    }
</style>

<h2>Edit Forecasts for Scenario: {{ scenario.version }}</h2>

<!-- Filter Form -->
<form method="get" class="mb-3">
    <div class="row">
        <div class="col-md-3">
            <input type="text" name="product" class="form-control" placeholder="Filter by Product"
                value="{{ request.GET.product }}">
        </div>
        <div class="col-md-3">
            <input type="text" name="region" class="form-control" placeholder="Filter by Forecast Region"
                value="{{ request.GET.region }}">
        </div>
        <div class="col-md-3">
            <input type="date" name="date" class="form-control" placeholder="Filter by Date"
                value="{{ request.GET.date }}">
        </div>
        <div class="col-md-3">
            <input type="text" name="location" class="form-control" placeholder="Filter by Location"
                value="{{ request.GET.location }}">
        </div>
        <div class="col-md-3 mt-2">
            <input type="text" name="product_group" class="form-control" placeholder="Filter by Product Group"
                value="{{ request.GET.product_group }}">
        </div>
        <div class="col-md-2 mt-2">
            <button type="submit" class="btn btn-primary">Filter</button>
        </div>
    </div>
</form>

<form method="post">
    {% csrf_token %}
    {{ formset.management_form }}
    <table id="forecastTable" class="table">
        <thead>
            <tr>
                <th>Data Source</th>
                <th>Forecast Region</th>
                <th>ProductGroup</th>
                <th>Product</th>
                <th>Family Description</th>
                <th>Customer Code</th>
                <th>Location</th>
                <th>Dress Mass</th>
                <th class="price-aud-header text-center align-middle" style="width:90px;">Price<br>AUD</th>
                <th>Date</th>
                <th>Qty</th>
            </tr>
        </thead>
        <tbody>
            {% for form in formset %}
            <tr>
                <td>{{ form.Data_Source }}</td>
                <td>{{ form.Forecast_Region }}</td>
                <td>{{ form.Product_Group }}</td>
                <td>{{ form.Product }}</td>
                <td>{{ form.ProductFamilyDescription }}</td>
                <td>{{ form.Customer_code }}</td>
                <td>{{ form.Location }}</td>
                <td>
                    {{ form.Forecasted_Weight_Curr.value|default_if_none:""|floatformat:1 }}
                </td>
                <td class="price-aud-cell">
            {% if form.PriceAUD.value %}
            {{ form.PriceAUD.value|floatformat:1 }}
            {% else %}
            {{ form.PriceAUD }}
            {% endif %}
        </td>
                <td>
                    {{ form.Period_AU }}
                </td>
                <td>
                    {{ form.Qty }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button type="submit" class="btn btn-primary">Save Changes</button>
</form>

{% if form_errors %}
<div class="alert alert-danger">
    <ul>
        {% for error in form_errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="pagination">
    <span class="step-links">
        {% if page_obj.has_previous %}
        <a
            href="?product={{ request.GET.product }}&region={{ request.GET.region }}&date={{ request.GET.date }}&location={{ request.GET.location }}&product_group={{ request.GET.product_group }}&page=1">&laquo;
            first</a>
        <a
            href="?product={{ request.GET.product }}&region={{ request.GET.region }}&date={{ request.GET.date }}&location={{ request.GET.location }}&product_group={{ request.GET.product_group }}&page={{ page_obj.previous_page_number }}">previous</a>
        {% endif %}

        <span class="current">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
        </span>

        {% if page_obj.has_next %}
        <a
            href="?product={{ request.GET.product }}&region={{ request.GET.region }}&date={{ request.GET.date }}&location={{ request.GET.location }}&product_group={{ request.GET.product_group }}&page={{ page_obj.next_page_number }}">next</a>
        <a
            href="?product={{ request.GET.product }}&region={{ request.GET.region }}&date={{ request.GET.date }}&location={{ request.GET.location }}&product_group={{ request.GET.product_group }}&page={{ page_obj.paginator.num_pages }}">last
            &raquo;</a>
        {% endif %}
    </span>
</div>

{% endblock %}