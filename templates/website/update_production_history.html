{% extends 'website/base.html' %}

{% block content %}
<div class="alert alert-info" role="alert">
    <strong>Scenario Version:</strong> {{ scenario.version }}
</div>
<h2>Update Production History for {{ scenario.version }}</h2>

<!-- Filter Form (Bootstrap style) -->
<form method="get" class="mb-3">
    <div class="row">
        <div class="col-md-3">
            <input type="text" name="product" class="form-control" placeholder="Filter by Product"
                value="{{ request.GET.product }}">
        </div>
        <div class="col-md-3">
            <input type="text" name="foundry" class="form-control" placeholder="Filter by Foundry"
                value="{{ request.GET.foundry }}">
        </div>
        <div class="col-md-3">
            <input type="month" name="production_month" class="form-control" placeholder="Filter by Month"
                value="{{ request.GET.production_month }}">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary">Filter</button>
        </div>
    </div>
</form>

<form method="post">
    {% csrf_token %}
    <table class="table table-bordered">
        {{ formset.management_form }}
        <thead>
            <tr>
                <th>Foundry</th>
                <th>Product</th>
                <th>Production Month</th>
                <th>Production Quantity</th>
            </tr>
        </thead>
        <tbody>
            {% for form in formset %}
            <tr>
                <td>{{ form.Foundry }}</td>
                <td>{{ form.Product }}</td>
                <td>{{ form.ProductionMonth }}</td>
                <td>{{ form.ProductionQty }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button type="submit" class="btn btn-primary">Save Changes</button>
    <a href="{% url 'edit_scenario' scenario.version %}" class="btn btn-secondary">Cancel</a>
    <a href="{% url 'edit_scenario' scenario.version %}" class="btn btn-primary ml-2">Back to Edit Scenario</a>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[method="post"]');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Allow form submission to continue
            setTimeout(function() {
                window.location.href = "{% url 'edit_scenario' scenario.version %}";
            }, 500);
        });
    }
});
</script>

<!-- Pagination Controls -->
<nav aria-label="Page navigation">
    <ul class="pagination">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?product={{ request.GET.product }}&foundry={{ request.GET.foundry }}&production_month={{ request.GET.production_month }}&page={{ page_obj.previous_page_number }}">Previous</a>
            </li>
        {% else %}
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?product={{ request.GET.product }}&foundry={{ request.GET.foundry }}&production_month={{ request.GET.production_month }}&page={{ page_obj.next_page_number }}">Next</a>
            </li>
        {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
    </ul>
</nav>
{% endblock %}