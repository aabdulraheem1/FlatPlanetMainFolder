{% extends 'website/base.html' %}
{% load static %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <title>Review Scenario - Fast Loading</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: white;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .quick-actions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>

{% if messages %}
  <div class="container mt-2">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

<div class="container-fluid mt-3">
    <!-- Quick Actions Section -->
    <div class="quick-actions">
        <h5>Quick Actions</h5>
        <div class="d-flex flex-wrap">
            <form method="post" action="{% url 'manual_optimize_product' version=version %}" class="mr-2 mb-2">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">Manual Optimize</button>
            </form>
            <button type="button" class="btn btn-warning mr-2 mb-2" data-toggle="modal" data-target="#autoLevelModal">
                Auto Level Optimization
            </button>
            <form method="post" action="{% url 'reset_production_plan' version=version %}" class="mr-2 mb-2">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger" onclick="return confirm('Reset production plan?')">
                    Reset Production Plan
                </button>
            </form>
            <a href="{% url 'review_scenario' version=version %}" class="btn btn-info mr-2 mb-2">
                Full Detailed View
            </a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row">
        <div class="col-md-12">
            <div class="summary-card">
                <h4>Scenario Summary: {{ version }}</h4>
                <div class="row">
                    <div class="col-md-3">
                        <h6>Total Demand Plan</h6>
                        <h3 id="totalDemand">Loading...</h3>
                    </div>
                    <div class="col-md-3">
                        <h6>Total Pour Plan</h6>
                        <h3 id="totalPour">Loading...</h3>
                    </div>
                    <div class="col-md-3">
                        <h6>Capacity Utilization</h6>
                        <h3 id="capacityUtil">Loading...</h3>
                    </div>
                    <div class="col-md-3">
                        <h6>Last Updated</h6>
                        <h3 id="lastUpdated">{{ now|date:"M d, H:i" }}</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row">
        <div class="col-md-4">
            <div class="metric-card">
                <h6>FY25 Performance</h6>
                <canvas id="fy25Chart" width="300" height="150"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="metric-card">
                <h6>Top Sites by Volume</h6>
                <div id="topSites">Loading...</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="metric-card">
                <h6>Recent Alerts</h6>
                <div id="recentAlerts">
                    <div class="alert alert-warning alert-sm">Check capacity gaps in FY26</div>
                    <div class="alert alert-info alert-sm">Optimization available</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Links -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h6>Quick Access</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <a href="#" onclick="loadDetailedSection('control-tower')" class="btn btn-outline-primary btn-block">
                                Control Tower Details
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="#" onclick="loadDetailedSection('forecast')" class="btn btn-outline-primary btn-block">
                                Forecast Analysis
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="#" onclick="loadDetailedSection('foundry')" class="btn btn-outline-primary btn-block">
                                Foundry Performance
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="#" onclick="loadDetailedSection('inventory')" class="btn btn-outline-primary btn-block">
                                Inventory Status
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for detailed sections -->
<div class="modal fade" id="detailModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalLabel">Loading...</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="detailModalBody">
                <div class="text-center p-5">
                    <div class="spinner-border" role="status"></div>
                    <p class="mt-3">Loading detailed data...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Auto Level Optimization Modal -->
<div class="modal fade" id="autoLevelModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Auto Level Optimization</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="post" action="{% url 'auto_level_optimization' version=version %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <h6>Select Sites:</h6>
                            <div id="sites-checkboxes">Loading...</div>
                        </div>
                    </div>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" value="90" id="maxDaysConstraint" name="max_days_constraint">
                        <label class="form-check-label" for="maxDaysConstraint">
                            Maximum 90 days difference
                        </label>
                    </div>
                    <div class="alert alert-info mt-3">
                        <small><strong>Note:</strong> Optimization will automatically process all product groups for the selected sites without preference.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Optimize</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
// Load summary data immediately
$(document).ready(function() {
    loadSummaryData();
    
    // Load auto-level data when modal opens
    $('#autoLevelModal').on('show.bs.modal', loadAutoLevelData);
});

function loadSummaryData() {
    fetch(`/scenario/{{ version }}/summary-data/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalDemand').textContent = data.total_demand?.toLocaleString() || '0';
            document.getElementById('totalPour').textContent = data.total_pour?.toLocaleString() || '0';
            document.getElementById('capacityUtil').textContent = data.capacity_util || '0%';
            
            // Update top sites
            if (data.top_sites) {
                const topSitesHtml = data.top_sites.map(site => 
                    `<div class="d-flex justify-content-between">
                        <span>${site.name}</span>
                        <strong>${site.volume.toLocaleString()}t</strong>
                    </div>`
                ).join('');
                document.getElementById('topSites').innerHTML = topSitesHtml;
            }
            
            // Create simple chart
            if (data.fy25_data) {
                createSimpleChart(data.fy25_data);
            }
        })
        .catch(error => console.error('Error loading summary:', error));
}

function createSimpleChart(data) {
    const ctx = document.getElementById('fy25Chart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.values,
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { fontSize: 10 }
                }
            }
        }
    });
}

function loadDetailedSection(section) {
    document.getElementById('detailModalLabel').textContent = 
        section.charAt(0).toUpperCase() + section.slice(1).replace('-', ' ') + ' Details';
    
    $('#detailModal').modal('show');
    
    fetch(`/scenario/{{ version }}/load-section/${section}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('detailModalBody').innerHTML = data.html || 
                `<div class="alert alert-danger">Error: ${data.error}</div>`;
        })
        .catch(error => {
            document.getElementById('detailModalBody').innerHTML = 
                `<div class="alert alert-danger">Error loading data: ${error.message}</div>`;
        });
}

function loadAutoLevelData() {
    fetch('{% url "auto_level_optimization" version=version %}?action=get_data')
        .then(response => response.json())
        .then(data => {
            if (data.optimization_applied) {
                alert('Auto optimization already applied. Reset production plan first.');
                $('#autoLevelModal').modal('hide');
                return;
            }
            
            // Populate sites
            const sitesHtml = data.sites.map(site => 
                `<div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${site}" id="site_${site}" name="selected_sites">
                    <label class="form-check-label" for="site_${site}">${site}</label>
                </div>`
            ).join('');
            document.getElementById('sites-checkboxes').innerHTML = sitesHtml;
        })
        .catch(error => console.error('Error loading auto-level data:', error));
}
</script>

{% endblock %}
