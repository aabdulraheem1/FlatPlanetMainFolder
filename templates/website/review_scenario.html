{% extends 'website/base.html' %}
{% load static %}

{% block content %}
<head>
    <title>Review Scenario - {{ version }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        /* Custom Extra Large Modal */
        .modal-xl-custom {
            max-width: 95vw !important;
            width: 95vw !important;
            margin: 1rem auto;
        }
        
        .modal-xl-custom .modal-content {
            height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-xl-custom .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }
        
        /* Work Transfer Modal Styles */
        #workTransferModal .table-responsive {
            border: 1px solid #dee2e6;
            max-height: 65vh;
            overflow-y: auto;
        }
        
        #workTransferModal .table th {
            background-color: #343a40;
            color: white;
            border-color: #454d55;
            font-size: 0.9em;
            padding: 0.75rem 0.5rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        #workTransferModal .table td {
            padding: 0.6rem 0.5rem;
            font-size: 0.9em;
            vertical-align: middle;
        }
        
        #workTransferModal .site-selector {
            min-width: 120px;
        }
        
        #workTransferModal .badge {
            font-size: 0.75em;
            margin-right: 3px;
            margin-bottom: 2px;
        }
        
        #workTransferModal .form-control-sm {
            font-size: 0.9rem;
        }
        
        #workTransferModal .btn {
            padding: 0.5rem 1rem;
        }
        
        /* Pagination styling */
        #workTransferModal .pagination-info {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        #workTransferModal .pagination .page-link {
            padding: 0.4rem 0.75rem;
            font-size: 0.85rem;
        }
        
        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
</head>

{% if messages %}
  <div class="container mt-2">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

<body>
    <div class="container mt-3">
        <h1 class="text-center mb-4">Review Scenario: {{ version }}</h1>
        
        <!-- Control Buttons -->
        <div class="text-center mb-4">
            <button type="button" class="btn btn-info mr-2" id="workTransferBtn" data-toggle="modal" data-target="#workTransferModal">
                <i class="fas fa-exchange-alt"></i> Work Transfer between Sites
            </button>
            
            <a href="{% url 'production_allocation_view' version=version %}" class="btn btn-success mr-2">
                <i class="fas fa-percentage"></i> Production Allocation
            </a>
            
            <button type="button" class="btn btn-primary mr-2" id="autoOptimizeBtn" data-toggle="modal" data-target="#autoLevelModal">
                Auto Level Optimization
            </button>
            
            <!-- Simple Reset Form (no AJAX needed) -->
            <form method="POST" action="{% url 'reset_production_plan' version=version %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-warning" onclick="return confirm('Are you sure you want to reset the production plan? This will run populate_calculated_production.py for this scenario.');">
                    <i class="fas fa-undo"></i> Reset Production Plan
                </button>
            </form>
        </div>

        <!-- Include all the original sections -->
        {% include 'website/control_tower.html' %}
        {% include 'website/forecast.html' %}
        {% include 'website/foundry.html' %}
        {% include 'website/supplier.html' %}
        {% include 'website/simple_inventory.html' %}
    </div>

    <!-- Work Transfer Modal -->
    <div class="modal fade" id="workTransferModal" tabindex="-1" role="dialog" aria-labelledby="workTransferModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl-custom" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="workTransferModalLabel">Work Transfer between Sites</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="workTransferLoader" class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> Loading production data...
                    </div>
                    <div id="workTransferContent" style="display: none;">
                        <!-- Filter Form (Server-side filtering) -->
                        <form id="filterForm" method="get" class="mb-3">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="filterProduct">Filter by Product:</label>
                                    <input type="text" 
                                           id="filterProduct" 
                                           name="product" 
                                           class="form-control form-control-sm" 
                                           placeholder="Enter product name..."
                                           value="{{ request.GET.product|default:'' }}">
                                </div>
                                <div class="col-md-3">
                                    <label for="filterSite">Filter by Current Site:</label>
                                    <input type="text" 
                                           id="filterSite" 
                                           name="site" 
                                           class="form-control form-control-sm" 
                                           placeholder="Enter site name..."
                                           value="{{ request.GET.site|default:'' }}">
                                </div>
                                <div class="col-md-3">
                                    <label for="filterGroup">Filter by Product Group:</label>
                                    <input type="text" 
                                           id="filterGroup" 
                                           name="group" 
                                           class="form-control form-control-sm" 
                                           placeholder="Enter product group..."
                                           value="{{ request.GET.group|default:'' }}">
                                </div>
                                <div class="col-md-3">
                                    <label for="filterSupplyOption">Filter by Supply Option:</label>
                                    <input type="text" 
                                           id="filterSupplyOption" 
                                           name="supply_option" 
                                           class="form-control form-control-sm" 
                                           placeholder="Enter supply option..."
                                           value="{{ request.GET.supply_option|default:'' }}">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-12 d-flex align-items-end">
                                    <button type="submit" class="btn btn-sm btn-primary mr-2">
                                        <i class="fas fa-search"></i> Filter
                                    </button>
                                    <button type="button" class="btn btn-sm btn-secondary mr-2" id="clearFilters">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                    <button type="button" class="btn btn-sm btn-success" id="productionAllocationBtn">
                                        <i class="fas fa-cogs"></i> Production Allocation
                                    </button>
                                </div>
                            </div>
                        </form>
                        
                        <!-- Work Transfer Form -->
                        <form id="workTransferForm" method="post">
                            {% csrf_token %}
                            
                            <!-- Records Info and Pagination Controls -->
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <small class="text-muted">
                                        Showing <span id="recordsInfo">0</span> records 
                                        <span id="filterInfo" style="display: none;">(filtered from <span id="totalRecords">0</span> total)</span>
                                    </small>
                                </div>
                                <div>
                                    <nav aria-label="Page navigation">
                                        <ul class="pagination pagination-sm mb-0" id="paginationControls">
                                            <!-- Pagination will be generated here -->
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                            
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-bordered table-sm table-striped">
                                    <thead class="thead-dark sticky-top">
                                        <tr>
                                            <th style="width: 100px;">Product</th>
                                            <th style="width: 100px;">Pouring Date</th>
                                            <th style="width: 80px;">Qty</th>
                                            <th style="width: 80px;">Tonnes</th>
                                            <th style="width: 120px;">Product Group</th>
                                            <th style="width: 120px;">Parent Group</th>
                                            <th style="width: 90px;">COGS AUD</th>
                                            <th style="width: 90px;">Revenue AUD</th>
                                            <th style="width: 120px;">Current Site</th>
                                            <th style="width: 120px;">Transfer To</th>
                                            <th style="width: 200px;">Supply Options</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productionTableBody">
                                        <!-- Dynamic content will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="saveTransfers">
                        <i class="fas fa-save"></i> Save Transfers
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto Level Modal -->
    <div class="modal fade" id="autoLevelModal" tabindex="-1" role="dialog" aria-labelledby="autoLevelModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="autoLevelModalLabel">Auto Level Optimization</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="autoLevelForm" method="post" action="{% url 'auto_level_optimization' version=version %}">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-12">
                                <h6>Select Sites:</h6>
                                <div id="sites-checkboxes">
                                    <!-- Sites will be loaded dynamically -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="limit_date_change" name="limit_date_change" checked>
                                <label class="form-check-label" for="limit_date_change">
                                    <strong>90-Day Forward Limit:</strong> Limit how far forward production can be moved (max 90 days)
                                </label>
                                <small class="form-text text-muted">
                                    When checked, production will only be moved forward by a maximum of 90 days from its original date.
                                    Uncheck to allow unlimited forward movement.
                                </small>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <small><strong>Note:</strong> Optimization will automatically process all product groups for the selected sites without preference.</small>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <strong>How Auto-Level Optimization Works:</strong>
                            <ul class="mb-0 mt-2">
                                <li><strong>Sequential Processing:</strong> Process months in chronological order starting from July 2025</li>
                                <li><strong>Month-by-Month Gap Filling:</strong> For each month, check if Pour Plan capacity exceeds current demand</li>
                                <li><strong>Forward Movement:</strong> If a gap exists, fill it by bringing production forward from future months</li>
                                <li><strong>Immediate Recalculation:</strong> After filling each month, move to the next month with updated data</li>
                                <li><strong>Product Priority:</strong> Process product groups in the order you select them</li>
                                <li><strong>90-Day Limit:</strong> Optionally limit how far forward production dates can be moved</li>
                            </ul>
                            <div class="mt-2 p-2 bg-light rounded">
                                <strong>Example:</strong> Start with July 2025 - if gap exists, fill from Aug/Sep/Oct. 
                                Then move to August 2025 - if gap exists (from moves or original data), fill from Sep/Oct/Nov. 
                                Continue month by month until all gaps are filled or no more moves are possible.
                            </div>
                        </div>
                    </form>
                    
                    <!-- Results container (hidden initially) -->
                    <div id="optimizationResults" style="display: none;" class="mt-4">
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle"></i> Optimization Complete!</h6>
                            <div id="optimizationSummary"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" form="autoLevelForm" class="btn btn-primary">Apply Optimization</button>
                    <button type="button" id="closeAndRefresh" class="btn btn-success" style="display: none;">
                        <i class="fas fa-sync"></i> Close & Refresh Inventory
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/review_scenario_charts.js' %}"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    <script>
        // Load sites and product groups when modal is opened
        $('#autoLevelModal').on('show.bs.modal', function (e) {
            $.ajax({
                url: '{% url "auto_level_optimization" version=version %}?action=get_data',
                type: 'GET',
                success: function(data) {
                    if (data.optimization_applied) {
                        alert('Auto optimization has already been applied to this scenario. Please reset the production plan first.');
                        $('#autoLevelModal').modal('hide');
                        return;
                    }
                    
                    const sitesContainer = document.getElementById('sites-checkboxes');
                    sitesContainer.innerHTML = '';
                    
                    // Filter to only show specified sites
                    const allowedSites = ['MTJ1', 'COI2', 'XUZ1', 'MER1', 'WOD1', 'WUN1'];
                    const filteredSites = data.sites.filter(site => allowedSites.includes(site));
                    
                    filteredSites.forEach(function(site) {
                        const div = document.createElement('div');
                        div.className = 'form-check';
                        div.innerHTML = 
                            '<input class="form-check-input" type="checkbox" value="' + site + '" id="site_' + site + '" name="selected_sites">' +
                            '<label class="form-check-label" for="site_' + site + '">' + site + '</label>';
                        sitesContainer.appendChild(div);
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error loading data:', error);
                    alert('Error loading data. Please try again.');
                }
            });
        });
        
        // Check optimization state on page load
        $(document).ready(function() {
            checkOptimizationState();
        });
        
        function checkOptimizationState() {
            $.ajax({
                url: '{% url "auto_level_optimization" version=version %}?action=get_data',
                type: 'GET',
                success: function(data) {
                    console.log('DEBUG: Optimization state response:', data);
                    console.log('DEBUG: optimization_applied =', data.optimization_applied);
                    
                    if (data.optimization_applied) {
                        // Optimization has been applied
                        console.log('DEBUG: Setting button to DISABLED (green)');
                        $('#autoOptimizeBtn').addClass('disabled')
                                           .attr('title', 'Auto optimization already applied. Reset production plan to enable.')
                                           .html('<i class="fas fa-check"></i> Auto Level Optimization (Applied)')
                                           .removeClass('btn-primary')
                                           .addClass('btn-success');
                    } else {
                        // Optimization not applied
                        console.log('DEBUG: Setting button to ENABLED (blue)');
                        $('#autoOptimizeBtn').removeClass('disabled btn-success')
                                           .addClass('btn-primary')
                                           .attr('title', 'Apply auto level optimization')
                                           .html('Auto Level Optimization');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error checking optimization state:', error);
                }
            });
        }
        
        // Auto level form submission with progress feedback
        $('#autoLevelForm').on('submit', function(e) {
            e.preventDefault();
            
            // Validate selections
            const selectedSites = $('input[name="selected_sites"]:checked').length;
            
            if (selectedSites === 0) {
                alert('Please select at least one site.');
                return;
            }
            
            // Show loading state
            const submitBtn = $('button[type="submit"][form="autoLevelForm"]');
            const originalText = submitBtn.html();
            submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Optimizing...');
            
            // Submit the form with AJAX
            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                data: $(this).serialize(),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response) {
                    console.log('DEBUG: AJAX success response:', response);
                    
                    // Check if it's a JSON response (AJAX) or redirect (non-AJAX)
                    if (response && typeof response === 'object') {
                        // AJAX response - show results in modal
                        if (response.success) {
                            $('#optimizationSummary').html(`
                                <p><strong>Records Moved:</strong> ${response.records_moved || 0}</p>
                                <p><strong>Total Tonnes:</strong> ${response.total_tonnes || 0}</p>
                                <p><strong>Sites Processed:</strong> ${response.sites_processed || 'N/A'}</p>
                                <p><strong>Status:</strong> ${response.message || 'Optimization completed successfully'}</p>
                            `);
                            $('#optimizationResults').show();
                            $('#autoLevelForm').hide();
                            $('#closeAndRefresh').show();
                            submitBtn.hide();
                        } else {
                            alert('Error: ' + (response.message || 'Unknown error occurred'));
                            submitBtn.prop('disabled', false).html(originalText);
                        }
                    } else {
                        // Non-AJAX response - redirect happened, close modal and reload
                        $('#autoLevelModal').modal('hide');
                        window.location.reload();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Optimization error:', error);
                    alert('Error during optimization. Please try again.');
                    submitBtn.prop('disabled', false).html(originalText);
                }
            });
        });
        
        // Close and refresh button handler
        $('#closeAndRefresh').on('click', function() {
            $('#autoLevelModal').modal('hide');
            window.location.reload();
        });
        
        // Work Transfer Modal JavaScript
        let currentPage = 1;
        const recordsPerPage = 20;
        let totalRecords = 0;
        let filteredRecords = 0;
        let currentFilters = {product: '', site: '', group: '', supply_option: ''}; // Add supply_option filter
        let changesWereMade = false; // Track if any transfers were saved
        
        $('#workTransferModal').on('show.bs.modal', function (e) {
            console.log('üîç Modal opening, resetting to page 1...');
            currentPage = 1;
            changesWereMade = false; // Reset changes flag when modal opens
            console.log('üîç Calling loadWorkTransferData...');
            loadWorkTransferData();
        });

        // Handle modal close - refresh page if changes were made
        $('#workTransferModal').on('hidden.bs.modal', function (e) {
            console.log('üîç Modal closing, changesWereMade:', changesWereMade);
            if (changesWereMade) {
                console.log('üîÑ Changes detected, refreshing page...');
                window.location.reload();
            }
        });
        
        // Handle filter form submission
        $('#filterForm').on('submit', function(e) {
            e.preventDefault();
            currentPage = 1; // Reset to first page when filtering
            loadWorkTransferData();
        });
        
        // Handle clear filters button
        $('#clearFilters').on('click', function() {
            $('#filterForm')[0].reset();
            currentPage = 1;
            loadWorkTransferData();
        });
        
        function loadWorkTransferData() {
            console.log('üîç loadWorkTransferData called, currentPage:', currentPage);
            $('#workTransferLoader').show();
            $('#workTransferContent').hide();
            
            // Get filter values from form
            const productFilter = $('#filterProduct').val().trim();
            const siteFilter = $('#filterSite').val().trim();
            const groupFilter = $('#filterGroup').val().trim();
            const supplyOptionFilter = $('#filterSupplyOption').val().trim();
            
            // Update currentFilters object
            currentFilters = {
                product: productFilter,
                site: siteFilter,
                group: groupFilter,
                supply_option: supplyOptionFilter
            };
            
            console.log('üîç Filters:', currentFilters);
            
            const params = new URLSearchParams({
                action: 'load_data',
                page: currentPage,
                per_page: recordsPerPage
            });
            
            // Add filters only if they have values
            if (productFilter) params.append('product', productFilter);
            if (siteFilter) params.append('site', siteFilter);
            if (groupFilter) params.append('group', groupFilter);
            if (supplyOptionFilter) params.append('supply_option', supplyOptionFilter);
            
            console.log('üîç Loading work transfer data...', params.toString());
            
            $.ajax({
                url: '{% url "work_transfer_between_sites" version=version %}?' + params.toString(),
                type: 'GET',
                timeout: 30000, // 30 second timeout
                success: function(data) {
                    console.log('üîç AJAX Success:', data);
                    if (data.success) {
                        totalRecords = data.total_records;
                        filteredRecords = data.filtered_records;
                        
                        populateWorkTransferTable(data.production_records);
                        updatePagination(data.pagination);
                        updateRecordsInfo();
                        
                        $('#workTransferLoader').hide();
                        $('#workTransferContent').show();
                    } else {
                        console.error('üîç Server Error:', data.error);
                        alert('Error loading data: ' + (data.error || 'Unknown error'));
                        $('#workTransferLoader').hide();
                        $('#workTransferContent').show();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('üîç AJAX Error:', xhr.status, status, error);
                    console.error('üîç Response Text:', xhr.responseText);
                    alert('Error loading data: ' + error + ' (Status: ' + xhr.status + ')');
                    $('#workTransferLoader').hide();
                    $('#workTransferContent').show();
                }
            });
        }
        
        function populateWorkTransferTable(records) {
            const tbody = $('#productionTableBody');
            tbody.empty();
            
            if (records.length === 0) {
                tbody.append('<tr><td colspan="11" class="text-center text-muted">No records found</td></tr>');
                return;
            }
            
            records.forEach(function(record) {
                // Get unique supply options (remove duplicates) and show raw source IDs only
                const uniqueSources = [...new Set(record.supply_options
                    .filter(option => {
                        const source = option.source || '';
                        return !(source.length === 6 && source.startsWith('BK'));
                    })
                    .map(option => option.source || 'Unknown')
                )];
                
                const supplyOptions = uniqueSources
                    .map(source => `<span class="badge badge-secondary mr-1">${source}</span>`)
                    .join('');
                
                const row = `
                    <tr data-record-id="${record.id}" data-product="${record.product}" 
                        data-site="${record.current_site}" data-group="${record.product_group}">
                        <td title="${record.product}">${record.product.length > 12 ? record.product.substring(0, 12) + '...' : record.product}</td>
                        <td>${record.pouring_date}</td>
                        <td>${parseFloat(record.production_quantity).toFixed(1)}</td>
                        <td>${parseFloat(record.tonnes).toFixed(1)}</td>
                        <td title="${record.product_group}">${record.product_group ? (record.product_group.length > 15 ? record.product_group.substring(0, 15) + '...' : record.product_group) : '-'}</td>
                        <td title="${record.parent_product_group}">${record.parent_product_group ? (record.parent_product_group.length > 15 ? record.parent_product_group.substring(0, 15) + '...' : record.parent_product_group) : '-'}</td>
                        <td>${record.cogs_aud ? parseFloat(record.cogs_aud).toFixed(0) : '0'}</td>
                        <td>${record.revenue_aud ? parseFloat(record.revenue_aud).toFixed(0) : '0'}</td>
                        <td><span class="badge badge-primary">${record.current_site}</span></td>
                        <td>
                            <select name="new_site_${record.id}" class="form-control form-control-sm site-selector">
                                ${record.available_sites.map(site => 
                                    `<option value="${site}" ${site === record.current_site ? 'selected' : ''}>${site}</option>`
                                ).join('')}
                            </select>
                        </td>
                        <td style="font-size: 0.8em;">${supplyOptions || '<span class="text-muted">No options</span>'}</td>
                    </tr>
                `;
                tbody.append(row);
            });
        }
        
        function updatePagination(pagination) {
            const paginationContainer = $('#paginationControls');
            paginationContainer.empty();
            
            if (pagination.total_pages <= 1) {
                return;
            }
            
            // Previous button
            const prevDisabled = pagination.current_page === 1 ? 'disabled' : '';
            paginationContainer.append(`
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" data-page="${pagination.current_page - 1}">Previous</a>
                </li>
            `);
            
            // Page numbers
            const startPage = Math.max(1, pagination.current_page - 2);
            const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);
            
            if (startPage > 1) {
                paginationContainer.append('<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>');
                if (startPage > 2) {
                    paginationContainer.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const active = i === pagination.current_page ? 'active' : '';
                paginationContainer.append(`
                    <li class="page-item ${active}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `);
            }
            
            if (endPage < pagination.total_pages) {
                if (endPage < pagination.total_pages - 1) {
                    paginationContainer.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
                }
                paginationContainer.append(`<li class="page-item"><a class="page-link" href="#" data-page="${pagination.total_pages}">${pagination.total_pages}</a></li>`);
            }
            
            // Next button
            const nextDisabled = pagination.current_page === pagination.total_pages ? 'disabled' : '';
            paginationContainer.append(`
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" data-page="${pagination.current_page + 1}">Next</a>
                </li>
            `);
        }
        
        function updateRecordsInfo() {
            const hasFilters = currentFilters.product || currentFilters.site || currentFilters.group || currentFilters.supply_option;
            
            if (hasFilters) {
                $('#recordsInfo').text(filteredRecords);
                $('#totalRecords').text(totalRecords);
                $('#filterInfo').show();
            } else {
                $('#recordsInfo').text(totalRecords);
                $('#filterInfo').hide();
            }
        }
        
        // Pagination click handler
        $(document).on('click', '#paginationControls .page-link', function(e) {
            e.preventDefault();
            const page = parseInt($(this).data('page'));
            if (page && page !== currentPage) {
                currentPage = page;
                loadWorkTransferData();
            }
        });
        
        // Save transfers
        $('#saveTransfers').on('click', function() {
            const transfers = [];
            const changedRows = $('#productionTableBody tr').filter(function() {
                const recordId = $(this).data('record-id');
                const currentSite = $(this).data('site');
                const newSite = $(this).find(`select[name="new_site_${recordId}"]`).val();
                return currentSite !== newSite && recordId; // Ensure recordId exists
            });
            
            if (changedRows.length === 0) {
                alert('No transfers to save. Please select different sites for the products you want to transfer.');
                return;
            }
            
            changedRows.each(function() {
                const recordId = $(this).data('record-id');
                const newSite = $(this).find(`select[name="new_site_${recordId}"]`).val();
                transfers.push({
                    record_id: recordId,
                    new_site: newSite
                });
            });
            
            if (confirm(`Save ${transfers.length} production transfers?`)) {
                const saveBtn = $('#saveTransfers');
                const originalText = saveBtn.html();
                saveBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');
                
                $.ajax({
                    url: '{% url "work_transfer_between_sites" version=version %}',
                    type: 'POST',
                    data: {
                        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val(),
                        'transfers': JSON.stringify(transfers)
                    },
                    success: function(response) {
                        if (response.success) {
                            changesWereMade = true; // Mark that changes were made
                            alert(`Successfully transferred ${response.transferred_count} production records.`);
                            // Reload current page to show updated data
                            loadWorkTransferData();
                        } else {
                            alert('Error saving transfers: ' + (response.error || 'Unknown error'));
                        }
                        saveBtn.prop('disabled', false).html(originalText);
                    },
                    error: function(xhr, status, error) {
                        console.error('Error saving transfers:', error);
                        alert('Error saving transfers. Please try again.');
                        saveBtn.prop('disabled', false).html(originalText);
                    }
                });
            }
        });

        // Production Allocation Modal
        $('#productionAllocationBtn').click(function() {
            $('#productionAllocationModal').modal('show');
        });

        // Product search functionality
        $('#searchProductBtn').click(function() {
            var searchTerm = $('#productSearch').val().trim();
            if (searchTerm.length < 2) {
                alert('Please enter at least 2 characters to search.');
                return;
            }
            
            $.ajax({
                url: '{% url "product_allocation_search" version=version %}',
                type: 'GET',
                data: { search: searchTerm },
                success: function(response) {
                    if (response.success) {
                        var html = '';
                        response.products.forEach(function(product) {
                            html += '<tr style="cursor: pointer;" onclick="selectProduct(\'' + product.Product + '\')">' +
                                   '<td>' + product.Product + '</td>' +
                                   '<td>' + product.ProductDescription + '</td>' +
                                   '<td>' + product.total_qty + '</td>' +
                                   '<td>' + product.site_name + '</td>' +
                                   '</tr>';
                        });
                        $('#productSearchResults').html(html);
                        $('#searchResultsDiv').show();
                    } else {
                        alert('Error: ' + response.error);
                    }
                },
                error: function() {
                    alert('Error searching products. Please try again.');
                }
            });
        });

        // Select product and load allocation form
        function selectProduct(productId) {
            $.ajax({
                url: '{% url "product_allocation_load" version=version %}',
                type: 'GET',
                data: { product: productId },
                success: function(response) {
                    if (response.success) {
                        $('#selectedProductName').text(response.product_name);
                        $('#selectedProduct').val(response.product_name);
                        
                        // Build allocation table
                        var html = '';
                        for (var month in response.allocation_data) {
                            var data = response.allocation_data[month];
                            html += '<tr>' +
                                   '<td>' + month + '</td>' +
                                   '<td>' + data.qty + '</td>' +
                                   '<td class="total-percentage">100%</td>' +
                                   '<td><select class="form-control site-select" data-month="' + month + '" data-site="1">' +
                                   '<option value="' + data.site + '">' + data.site + '</option>' +
                                   response.all_sites.map(function(site) {
                                       return site !== data.site ? '<option value="' + site + '">' + site + '</option>' : '';
                                   }).join('') +
                                   '</select></td>' +
                                   '<td><input type="number" class="form-control percentage-input" data-month="' + month + '" data-site="1" value="100" max="100" min="0"></td>' +
                                   '<td><select class="form-control site-select" data-month="' + month + '" data-site="2"><option value="">Select Site</option>' +
                                   response.all_sites.map(function(site) {
                                       return '<option value="' + site + '">' + site + '</option>';
                                   }).join('') +
                                   '</select></td>' +
                                   '<td><input type="number" class="form-control percentage-input" data-month="' + month + '" data-site="2" value="0" max="100" min="0"></td>' +
                                   '<td><select class="form-control site-select" data-month="' + month + '" data-site="3"><option value="">Select Site</option>' +
                                   response.all_sites.map(function(site) {
                                       return '<option value="' + site + '">' + site + '</option>';
                                   }).join('') +
                                   '</select></td>' +
                                   '<td><input type="number" class="form-control percentage-input" data-month="' + month + '" data-site="3" value="0" max="100" min="0"></td>' +
                                   '</tr>';
                        }
                        $('#allocationTableBody').html(html);
                        
                        $('#searchResultsDiv').hide();
                        $('#allocationFormDiv').show();
                    } else {
                        alert('Error: ' + response.error);
                    }
                },
                error: function() {
                    alert('Error loading product data. Please try again.');
                }
            });
        }

        // Validate percentages
        $(document).on('input', '.percentage-input', function() {
            var month = $(this).data('month');
            var total = 0;
            $('input[data-month="' + month + '"].percentage-input').each(function() {
                var val = parseFloat($(this).val()) || 0;
                total += val;
            });
            
            var row = $(this).closest('tr');
            var totalCell = row.find('.total-percentage');
            if (total > 100) {
                totalCell.text(total + '% (Error!)').css('color', 'red');
            } else if (total < 100) {
                totalCell.text(total + '% (Remaining: ' + (100-total) + '%)').css('color', 'orange');
            } else {
                totalCell.text(total + '%').css('color', 'green');
            }
        });

        // Save allocation
        $('#saveAllocationBtn').click(function() {
            var productId = $('#selectedProduct').val();
            var allocationData = {};
            
            $('#allocationTableBody tr').each(function() {
                var row = $(this);
                var month = row.find('td').first().text();
                var qty = row.find('td').eq(1).text();
                
                var site1 = row.find('select[data-site="1"]').val();
                var perc1 = row.find('input[data-site="1"]').val();
                var site2 = row.find('select[data-site="2"]').val();
                var perc2 = row.find('input[data-site="2"]').val();
                var site3 = row.find('select[data-site="3"]').val();
                var perc3 = row.find('input[data-site="3"]').val();
                
                allocationData[month] = {
                    qty: qty,
                    sites: [site1, site2, site3],
                    percentages: [perc1, perc2, perc3]
                };
            });
            
            $.ajax({
                url: '{% url "product_allocation_save" version=version %}',
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val(),
                    'product': productId,
                    'allocation_data': JSON.stringify(allocationData)
                },
                success: function(response) {
                    if (response.success) {
                        alert('Allocation saved successfully!');
                        $('#productionAllocationModal').modal('hide');
                        location.reload(); // Reload to see changes
                    } else {
                        alert('Error: ' + response.error);
                    }
                },
                error: function() {
                    alert('Error saving allocation. Please try again.');
                }
            });
        });
    </script>

    <!-- Production Allocation Modal -->
    <div class="modal fade" id="productionAllocationModal" tabindex="-1" role="dialog" aria-labelledby="productionAllocationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl-custom" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productionAllocationModalLabel">Production Site Allocation</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Product Search -->
                    <div id="productSearchDiv">
                        <div class="row">
                            <div class="col-md-8">
                                <label for="productSearch">Search Product:</label>
                                <input type="text" id="productSearch" class="form-control" placeholder="Enter product name or code...">
                            </div>
                            <div class="col-md-4">
                                <label>&nbsp;</label><br>
                                <button type="button" id="searchProductBtn" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Search
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="searchResultsDiv" style="display: none;">
                        <hr>
                        <h6>Search Results:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Description</th>
                                        <th>Total Qty</th>
                                        <th>Current Site</th>
                                    </tr>
                                </thead>
                                <tbody id="productSearchResults">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Allocation Form -->
                    <div id="allocationFormDiv" style="display: none;">
                        <hr>
                        <h6>Production Allocation for: <span id="selectedProductName"></span></h6>
                        <input type="hidden" id="selectedProduct">
                        
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th rowspan="2">Month</th>
                                        <th rowspan="2">Qty</th>
                                        <th rowspan="2">Total %</th>
                                        <th colspan="2">Site 1</th>
                                        <th colspan="2">Site 2</th>
                                        <th colspan="2">Site 3</th>
                                    </tr>
                                    <tr>
                                        <th>Site</th>
                                        <th>%</th>
                                        <th>Site</th>
                                        <th>%</th>
                                        <th>Site</th>
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody id="allocationTableBody">
                                </tbody>
                            </table>
                        </div>

                        <div class="text-right">
                            <button type="button" class="btn btn-success" id="saveAllocationBtn">
                                <i class="fas fa-save"></i> Save Allocation
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Production Allocation Modal -->
    <div class="modal fade" id="allocationModal" tabindex="-1" role="dialog" aria-labelledby="allocationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="allocationModalLabel">Production Allocation by Percentage</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Product Search -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="productSearch"><strong>Search Product:</strong></label>
                            <input type="text" id="productSearch" class="form-control" placeholder="Type product name (e.g., T810EP, BF200, etc.)">
                            <div id="productSuggestions" class="list-group mt-1" style="display: none; position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                        </div>
                        <div class="col-md-4">
                            <label>&nbsp;</label><br>
                            <button type="button" class="btn btn-primary" id="loadProductBtn">
                                <i class="fas fa-search"></i> Load Product
                            </button>
                        </div>
                    </div>
                    
                    <div id="selectedProduct" style="display: none;">
                        <div class="alert alert-info">
                            <strong>Selected Product:</strong> <span id="selectedProductName"></span>
                        </div>
                        
                        <!-- Allocation Table -->
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Month</th>
                                        <th>Total Qty</th>
                                        <th>Site 1</th>
                                        <th>Site 1 %</th>
                                        <th>Site 2</th>
                                        <th>Site 2 %</th>
                                        <th>Site 3</th>
                                        <th>Site 3 %</th>
                                    </tr>
                                </thead>
                                <tbody id="allocationTableBody">
                                    <!-- Dynamic content will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="saveAllocation" style="display: none;">
                        <i class="fas fa-save"></i> Save Allocation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Production Allocation functionality
    $(document).ready(function() {
        const version = "{{ version }}"; // Define version from Django context
        let currentProduct = null;
        let allSites = [];
        
        // Load product data when search button is clicked
        $('#loadProductBtn').click(function() {
            const productName = $('#productSearch').val().trim();
            if (productName.length < 2) {
                alert('Please enter at least 2 characters');
                return;
            }
            
            // First verify the product exists
            $.ajax({
                url: '/scenario/' + version + '/search-products/',
                data: { search: productName },
                success: function(response) {
                    if (response.success && response.products.length > 0) {
                        // Product found, now load allocation data
                        const product = response.products.find(p => p.product === productName);
                        if (product) {
                            loadProductAllocation(productName);
                        } else {
                            alert('Exact product match not found. Available products: ' + response.products.map(p => p.product).join(', '));
                        }
                    } else {
                        alert(response.message || 'Product not found');
                    }
                },
                error: function() {
                    alert('Error searching for product');
                }
            });
        });
        
        // Function to load allocation data for a specific product
        function loadProductAllocation(productName) {
            $.ajax({
                url: '/scenario/' + version + '/get-allocation/',
                data: { product_id: productName },
                success: function(response) {
                    if (response.success) {
                        currentProduct = productName;
                        allSites = response.all_sites;
                        $('#selectedProductName').text(response.product_name);
                        loadAllocationTable(response.allocation_data);
                        $('#selectedProduct').show();
                        $('#saveAllocation').show();
                    } else {
                        alert(response.error || 'Error loading product allocation data');
                    }
                },
                error: function() {
                    alert('Error loading product allocation data');
                }
            });
        }
        
        // Product search functionality with debounce for better performance
        let productSearchTimeout;
        $('#productSearch').on('input', function() {
            const searchTerm = $(this).val().trim();
            
            // Clear previous timeout
            clearTimeout(productSearchTimeout);
            
            if (searchTerm.length >= 2) {
                // Add visual feedback
                $('#productSuggestions').html('<div class="list-group-item"><i class="fas fa-spinner fa-spin"></i> Searching...</div>').show();
                
                // Debounce search with 300ms delay
                productSearchTimeout = setTimeout(function() {
                    $.ajax({
                        url: '/scenario/' + version + '/search-products/',
                        data: { search: searchTerm },
                        success: function(response) {
                            if (response.success && response.products.length > 0) {
                                let html = '';
                                response.products.forEach(function(product) {
                                    html += '<a href="#" class="list-group-item list-group-item-action product-suggestion" data-product="' + product.product + '">';
                                    html += '<strong>' + product.product + '</strong>';
                                    if (product.description) {
                                        html += '<br><small class="text-muted">' + product.description + '</small>';
                                    }
                                    html += '</a>';
                                });
                                $('#productSuggestions').html(html).show();
                            } else {
                                $('#productSuggestions').html('<div class="list-group-item text-muted">No products found</div>').show();
                            }
                        },
                        error: function() {
                            $('#productSuggestions').html('<div class="list-group-item text-danger">Error searching. Please try again.</div>').show();
                        }
                    });
                }, 300); // 300ms debounce delay
            } else if (searchTerm.length === 0) {
                $('#productSuggestions').hide();
            } else {
                $('#productSuggestions').html('<div class="list-group-item text-muted">Type at least 2 characters...</div>').show();
            }
        });
        
        // Handle product suggestion clicks
        $(document).on('click', '.product-suggestion', function(e) {
            e.preventDefault();
            const productName = $(this).data('product');
            $('#productSearch').val(productName);
            $('#productSuggestions').hide();
        });
        
        // Save allocation
        $('#saveAllocation').click(function() {
            const allocationData = [];
            $('#allocationTableBody tr').each(function() {
                const row = $(this);
                allocationData.push({
                    month: row.find('.month-cell').text(),
                    site1: row.find('.site1-select').val(),
                    site1_percent: parseFloat(row.find('.site1-percent').val()) || 0,
                    site2: row.find('.site2-select').val(),
                    site2_percent: parseFloat(row.find('.site2-percent').val()) || 0,
                    site3: row.find('.site3-select').val(),
                    site3_percent: parseFloat(row.find('.site3-percent').val()) || 0
                });
            });
            
            $.ajax({
                url: '/scenario/' + version + '/save-allocation/',
                method: 'POST',
                data: {
                    product_id: currentProduct,
                    allocation_data: JSON.stringify(allocationData),
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        alert('Allocation saved successfully!');
                        $('#allocationModal').modal('hide');
                    } else {
                        alert('Error: ' + response.error);
                    }
                },
                error: function() {
                    alert('Error saving allocation');
                }
            });
        });
        
        function loadAllocationTable(data) {
            let html = '';
            data.forEach(function(monthData) {
                html += '<tr>';
                html += '<td class="month-cell">' + monthData.month + '</td>';
                html += '<td>' + monthData.total_qty + '</td>';
                
                // Site 1 (pre-populated)
                html += '<td>';
                html += '<select class="form-control site1-select">';
                allSites.forEach(function(site) {
                    html += '<option value="' + site + '"' + (site === monthData.site1 ? ' selected' : '') + '>' + site + '</option>';
                });
                html += '</select>';
                html += '</td>';
                html += '<td><input type="number" class="form-control site1-percent" value="' + monthData.site1_percent + '" min="0" max="100"></td>';
                
                // Site 2
                html += '<td>';
                html += '<select class="form-control site2-select">';
                html += '<option value="">-- Select Site --</option>';
                allSites.forEach(function(site) {
                    html += '<option value="' + site + '">' + site + '</option>';
                });
                html += '</select>';
                html += '</td>';
                html += '<td><input type="number" class="form-control site2-percent" value="0" min="0" max="100"></td>';
                
                // Site 3
                html += '<td>';
                html += '<select class="form-control site3-select">';
                html += '<option value="">-- Select Site --</option>';
                allSites.forEach(function(site) {
                    html += '<option value="' + site + '">' + site + '</option>';
                });
                html += '</select>';
                html += '</td>';
                html += '<td><input type="number" class="form-control site3-percent" value="0" min="0" max="100"></td>';
                
                html += '</tr>';
            });
            $('#allocationTableBody').html(html);
        }
    });
    </script>
    </script>
</body>
{% endblock %}
