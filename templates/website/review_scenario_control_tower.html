{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Control Tower</title>
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <style>
        .ct-table th,
        .ct-table td {
            text-align: center;
            vertical-align: middle;
            border: 1px solid #888;
            padding: 6px 10px;
        }
        .ct-table th {
            background: #e9ecef;
        }
        .ct-table .row-label {
            background: #f5f5f5;
            font-weight: bold;
            text-align: left;
        }
        .ct-table .total-row {
            background: #f0f0f0;
            font-weight: bold;
        }
        .ct-table .highlight {
            background: #d3d3d3;
        }
        .breakdown-info {
            font-size: 0.85em;
            color: #666;
            font-style: italic;
        }
        /* Updated styling for clickable demand plan numbers */
        .demand-plan-click, .pour-plan-click {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            color: #0066cc;
            font-weight: bold;
        }
        .demand-plan-click:hover, .pour-plan-click:hover {
            background-color: #f8f9fa;
            border-radius: 3px;
            color: #004499;
        }
        /* Modal styling */
        .modal-header {
            background-color: #e9ecef;
            border-bottom: 2px solid #dee2e6;
        }
        .monthly-breakdown-table {
            font-size: 13px;
        }
        .monthly-breakdown-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            text-align: center;
        }
        .monthly-breakdown-table td {
            text-align: right;
            padding: 6px 8px;
        }
        .monthly-breakdown-table .month-column {
            text-align: left;
        }
        .monthly-breakdown-table tfoot {
            background-color: #e9ecef;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h3>Control Tower</h3>
    <ul class="nav nav-tabs" id="controlTowerTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="fy25-tab" data-bs-toggle="tab" data-bs-target="#fy25" type="button"
                role="tab" aria-controls="fy25" aria-selected="true">FY25</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="fy26-tab" data-bs-toggle="tab" data-bs-target="#fy26" type="button" role="tab"
                aria-controls="fy26" aria-selected="false">FY26</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="fy27-tab" data-bs-toggle="tab" data-bs-target="#fy27" type="button" role="tab"
                aria-controls="fy27" aria-selected="false">FY27</button>
        </li>
    </ul>
    <div class="tab-content" id="controlTowerTabContent">
        <!-- FY25 Tab -->
        <div class="tab-pane fade show active p-3" id="fy25" role="tabpanel" aria-labelledby="fy25-tab">
            <table class="table ct-table" style="width:auto; min-width:900px;">
                <thead>
                    <tr>
                        <th></th>
                        <th>FY25 Budget</th>
                        <th>Available Capacity</th>
                        <th>Current Pour Plan</th>
                        <th>Current Demand Plan
                            <div class="breakdown-info">Click for monthly details</div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-label">Mt Joli</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">
                            <span class="pour-plan-click" data-fy="FY25" data-site="MTJ1" data-site-name="Mt Joli">
                                {{ pour_plan.FY25.MTJ1|intcomma }}
                            </span>
                        </td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY25" data-site="MTJ1" data-site-name="Mt Joli">
                                {{ demand_plan.FY25.MTJ1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Coimbatore</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">
                            <span class="pour-plan-click" data-fy="FY25" data-site="COI2" data-site-name="Coimbatore">
                                {{ pour_plan.FY25.COI2|intcomma }}
                            </span>
                        </td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY25" data-site="COI2" data-site-name="Coimbatore">
                                {{ demand_plan.FY25.COI2|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Xuzhou</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY25.XUZ1|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY25" data-site="XUZ1" data-site-name="Xuzhou">
                                {{ demand_plan.FY25.XUZ1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Merlimau</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY25.MER1|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY25" data-site="MER1" data-site-name="Merlimau">
                                {{ demand_plan.FY25.MER1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Wundowie</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY25.WUN1|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY25" data-site="WUN1" data-site-name="Wundowie">
                                {{ demand_plan.FY25.WUN1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Wodonga</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY25.WOD1|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY25" data-site="WOD1" data-site-name="Wodonga">
                                {{ demand_plan.FY25.WOD1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Chilca</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY25.CHI1|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY25" data-site="CHI1" data-site-name="Chilca">
                                {{ demand_plan.FY25.CHI1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr class="total-row">
                        <td>Total Castings</td>
                        <td></td>
                        <td></td>
                        <td>72,254</td>
                        <td>65,534</td>
                    </tr>
                    <tr>
                        <td class="row-label">Outsource</td>
                        <td></td>
                        <td></td>
                        <td class="highlight">11,182</td>
                        <td class="highlight">11,182</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- FY26 Tab -->
        <div class="tab-pane fade p-3" id="fy26" role="tabpanel" aria-labelledby="fy26-tab">
            <table class="table ct-table" style="width:auto; min-width:900px;">
                <thead>
                    <tr>
                        <th></th>
                        <th>FY26 Budget</th>
                        <th>Available Capacity</th>
                        <th>Current Pour Plan</th>
                        <th>Current Demand Plan
                            <div class="breakdown-info">Click for monthly details</div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-label">Mt Joli</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY26.MTJ1|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY26" data-site="MTJ1" data-site-name="Mt Joli">
                                {{ demand_plan.FY26.MTJ1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Coimbatore</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY26.COI2|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY26" data-site="COI2" data-site-name="Coimbatore">
                                {{ demand_plan.FY26.COI2|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Xuzhou</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY26.XUZ1|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY26" data-site="XUZ1" data-site-name="Xuzhou">
                                {{ demand_plan.FY26.XUZ1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Merlimau</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY26.MER1|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY26" data-site="MER1" data-site-name="Merlimau">
                                {{ demand_plan.FY26.MER1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Wundowie</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY26.WUN1|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY26" data-site="WUN1" data-site-name="Wundowie">
                                {{ demand_plan.FY26.WUN1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Wodonga</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY26.WOD1|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY26" data-site="WOD1" data-site-name="Wodonga">
                                {{ demand_plan.FY26.WOD1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Chilca</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY26.CHI1|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY26" data-site="CHI1" data-site-name="Chilca">
                                {{ demand_plan.FY26.CHI1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr class="total-row">
                        <td>Total Castings</td>
                        <td></td>
                        <td></td>
                        <td>72,254</td>
                        <td>65,534</td>
                    </tr>
                    <tr>
                        <td class="row-label">Outsource</td>
                        <td></td>
                        <td></td>
                        <td class="highlight">11,182</td>
                        <td class="highlight">11,182</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- FY27 Tab -->
        <div class="tab-pane fade p-3" id="fy27" role="tabpanel" aria-labelledby="fy27-tab">
            <table class="table ct-table" style="width:auto; min-width:900px;">
                <thead>
                    <tr>
                        <th></th>
                        <th>FY27 Budget</th>
                        <th>Available Capacity</th>
                        <th>Current Pour Plan</th>
                        <th>Current Demand Plan
                            <div class="breakdown-info">Click for monthly details</div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-label">Mt Joli</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY27.MTJ1|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY27" data-site="MTJ1" data-site-name="Mt Joli">
                                {{ demand_plan.FY27.MTJ1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Coimbatore</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY27.COI2|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY27" data-site="COI2" data-site-name="Coimbatore">
                                {{ demand_plan.FY27.COI2|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Xuzhou</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY27.XUZ1|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY27" data-site="XUZ1" data-site-name="Xuzhou">
                                {{ demand_plan.FY27.XUZ1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Merlimau</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY27.MER1|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY27" data-site="MER1" data-site-name="Merlimau">
                                {{ demand_plan.FY27.MER1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Wundowie</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY27.WUN1|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY27" data-site="WUN1" data-site-name="Wundowie">
                                {{ demand_plan.FY27.WUN1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Wodonga</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY27.WOD1|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY27" data-site="WOD1" data-site-name="Wodonga">
                                {{ demand_plan.FY27.WOD1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="row-label">Chilca</td>
                        <td></td>
                        <td class="highlight"></td>
                        <td class="highlight">{{ pour_plan.FY27.CHI1|intcomma }}</td>
                        <td class="highlight">
                            <span class="demand-plan-click" data-fy="FY27" data-site="CHI1" data-site-name="Chilca">
                                {{ demand_plan.FY27.CHI1|intcomma }}
                            </span>
                        </td>
                    </tr>
                    <tr class="total-row">
                        <td>Total Castings</td>
                        <td></td>
                        <td></td>
                        <td>72,254</td>
                        <td>65,534</td>
                    </tr>
                    <tr>
                        <td class="row-label">Outsource</td>
                        <td></td>
                        <td></td>
                        <td class="highlight">11,182</td>
                        <td class="highlight">11,182</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal for Monthly Breakdown -->
<div class="modal fade" id="monthlyBreakdownModal" tabindex="-1" aria-labelledby="monthlyBreakdownModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="monthlyBreakdownModalLabel">Monthly Breakdown</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modalContent">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<!-- ...existing HTML... -->

<script>
// Cache for loaded table data to avoid repeated AJAX calls
window.detailedMonthlyTableCache = {};

// Handle click events on demand plan and pour plan numbers
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('demand-plan-click') || e.target.classList.contains('pour-plan-click')) {
        const fy = e.target.getAttribute('data-fy');
        const site = e.target.getAttribute('data-site');
        const siteName = e.target.getAttribute('data-site-name');
        const planType = e.target.classList.contains('pour-plan-click') ? 'Pour Plan' : 'Demand Plan';
        
        console.log(`🖱️ Clicked on ${siteName} (${site}) for ${fy} - ${planType}`);
        
        // Update modal title
        document.getElementById('monthlyBreakdownModalLabel').textContent = 
            `Monthly Breakdown - ${siteName} (${fy}) - ${planType}`;
        
        // Check cache first
        const cacheKey = `${fy}-${site}`;
        if (window.detailedMonthlyTableCache[cacheKey]) {
            console.log('📊 Using cached data for', fy, site);
            document.getElementById('modalContent').innerHTML = window.detailedMonthlyTableCache[cacheKey];
            showModal();
            return;
        }
        
        // Show loading indicator
        document.getElementById('modalContent').innerHTML = `
            <div style="padding: 40px; text-align: center;">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="mt-3">Loading monthly breakdown data...</p>
            </div>
        `;
        
        showModal();
        
        // Load data via AJAX
        fetch(`/scenario/{{ version }}/detailed-monthly-table/?fy=${fy}&site=${site}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('✅ Loaded data via AJAX for', fy, site);
                    // Cache the data
                    window.detailedMonthlyTableCache[cacheKey] = data.html;
                    // Display the data
                    document.getElementById('modalContent').innerHTML = data.html;
                } else {
                    console.error('❌ Error loading data:', data.error);
                    document.getElementById('modalContent').innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <h5>Error Loading Data</h5>
                            <p class="text-danger">${data.error}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('❌ AJAX error:', error);
                document.getElementById('modalContent').innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <h5>Connection Error</h5>
                        <p class="text-danger">Failed to load data. Please try again.</p>
                        <button class="btn btn-primary" onclick="location.reload()">Refresh Page</button>
                    </div>
                `;
            });
    }
});

function showModal() {
    const modal = new bootstrap.Modal(document.getElementById('monthlyBreakdownModal'));
    modal.show();
}

console.log('🚀 AJAX-based modal handlers initialized');
</script>
</body>
</html>